const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-C5E9Z3hJ.js","assets/vue-vendor-kiT1BP1D.js","assets/math-vendor-C4rbpj_m.js","assets/markdown-vendor-BDlm1NQN.js","assets/index-DCljqfLO.css"])))=>i.map(i=>d[i]);
import{aB as ee}from"./math-vendor-C4rbpj_m.js";import{u as X,r as D,q as te,m as Z,d as ae,c as H,s as re,o as oe,x as J,a as _,b as r,t as p,e as a,j as N,F as B,h as L,y as se,g,l as y,w,v as A,z as le,f as ie,i as S}from"./vue-vendor-kiT1BP1D.js";import{c as ne,g as ce,b as de}from"./index-C5E9Z3hJ.js";import{u as ue}from"./useCategories-C2sffmD1.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./markdown-vendor-BDlm1NQN.js";const me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Y=(o=21)=>{let l="",v=crypto.getRandomValues(new Uint8Array(o|=0));for(;o--;)l+=me[v[o]&63];return l};function G(o){const l=[];return o.title&&l.push(`title: ${E(o.title)}`),o.description&&l.push(`description: ${E(o.description)}`),o.categoryKey&&l.push(`categoryKey: ${E(o.categoryKey)}`),o.tag&&l.push(`tag: ${E(o.tag)}`),o.badge&&l.push(`badge: ${E(o.badge)}`),o.date&&l.push(`date: ${E(o.date)}`),o.platform&&l.push(`platform: ${E(o.platform)}`),o.cover&&l.push(`cover: ${E(o.cover)}`),(l.length>0?`---
${l.join(`
`)}
---

`:"")+(o.content||"").trim()}function E(o){return o.includes(":")||o.includes("#")||o.includes("|")||o.includes("&")||o.includes("*")||o.includes("!")||o.includes("%")||o.includes("@")||o.includes("`")||o.startsWith(" ")||o.endsWith(" ")||o.includes(`
`)?`"${o.replace(/"/g,'\\"')}"`:o}function Q(o){const l=o.date||new Date().toISOString().split("T")[0],k=(o.title||"untitled").toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();return`${l}-${k}`}const j=new Map;function q(o,l){try{const v=localStorage.getItem("article-file-handles")||"{}",k=JSON.parse(v);k[o]=l,localStorage.setItem("article-file-handles",JSON.stringify(k))}catch(v){console.error("Failed to save file handle:",v)}}function pe(o){try{const l=localStorage.getItem("article-file-handles");if(l)return JSON.parse(l)[o]||null}catch(l){console.error("Failed to get file handle name:",l)}return null}const ge=()=>{const o=Z(),{messages:l,locale:v}=X(),k=D(!1),K=D(!1),W=(()=>{const m=l.value[v.value]?.categories||{},F=Object.keys(m).filter(f=>f!=="all");return F.length>0?F[0]:"c/c++"})(),e=te({title:"",description:"",content:"",categoryKey:W,tag:"",badge:"",date:new Date().toISOString().split("T")[0],platform:"Wechat",cover:"linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)"}),i=()=>{e.title="",e.description="",e.content="",e.categoryKey=W,e.tag="",e.badge="",e.date=new Date().toISOString().split("T")[0],e.platform="Wechat",e.cover="linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)"},I=c=>ne.some(m=>m.id===c),x=c=>{e.id=c.id,e.title=c.title,e.description=c.description,e.content=c.content,e.categoryKey=c.categoryKey,e.tag=c.tag,e.badge=c.badge,e.date=c.date,e.platform=c.platform,e.cover=c.cover},s=()=>{const c=[];return e.title?.trim()||c.push({field:"title",message:"title"}),e.description?.trim()||c.push({field:"description",message:"description"}),e.content?.trim()||c.push({field:"content",message:"content"}),e.categoryKey||c.push({field:"category",message:"category"}),e.tag?.trim()||c.push({field:"tag",message:"tag"}),e.date||c.push({field:"date",message:"date"}),e.platform?.trim()||c.push({field:"platform",message:"platform"}),e.cover?.trim()||c.push({field:"cover",message:"cover"}),c},V=async()=>s().length>0?null:{id:e.id||Y(),title:e.title||"",description:e.description||"",content:e.content||"",categoryKey:e.categoryKey||"dit",tag:e.tag||"",badge:e.badge,date:e.date||new Date().toISOString().split("T")[0],platform:e.platform||"Wechat",cover:e.cover||""};return{form:e,isSubmitting:k,isSavingFile:K,resetForm:i,loadArticle:x,validateForm:s,handleSubmit:V,handleSubmitAndRedirect:async()=>{const c=await V();c&&o.push({name:"articleDetail",params:{id:c.id}})},handlePublish:async()=>{if(s().length>0)return!1;if(!("showSaveFilePicker"in window))return alert("您的浏览器不支持文件系统访问 API，请使用 Chrome、Edge 或 Opera 浏览器"),!1;K.value=!0;try{const m={id:e.id||Y(),title:e.title||"",description:e.description||"",content:e.content||"",categoryKey:e.categoryKey||W,tag:e.tag||"",badge:e.badge,date:e.date||new Date().toISOString().split("T")[0],platform:e.platform||"Wechat",cover:e.cover||""},F=G(m);let f=Q(m)+".md";if(e.filename?.trim()){let C=e.filename.trim();C.endsWith(".md")||(C=C+".md"),f=C}const d=await window.showSaveFilePicker({suggestedName:f,types:[{description:"Markdown files",accept:{"text/markdown":[".md"]}}]}),h=d.name,P=await d.createWritable();await P.write(F),await P.close();const $=ce(h);return j.set($,d),q($,h),!0}catch(m){return m.name!=="AbortError"&&(console.error("Failed to save file:",m),alert("保存文件失败："+(m.message||"未知错误"))),!1}finally{K.value=!1}},handleUpdate:async()=>{if(s().length>0||!e.id)return!1;if(!("showSaveFilePicker"in window))return alert("您的浏览器不支持文件系统访问 API，请使用 Chrome、Edge 或 Opera 浏览器"),!1;K.value=!0;try{const m={id:e.id,title:e.title||"",description:e.description||"",content:e.content||"",categoryKey:e.categoryKey||W,tag:e.tag||"",badge:e.badge,date:e.date||new Date().toISOString().split("T")[0],platform:e.platform||"Wechat",cover:e.cover||""},F=G(m),f=Q(m)+".md";let d=j.get(e.id);if(!d){const h=pe(e.id);try{d=(await window.showOpenFilePicker({types:[{description:"Markdown files",accept:{"text/markdown":[".md"]}}],multiple:!1}))[0],j.set(e.id,d),h?q(e.id,h):q(e.id,f)}catch(P){if(P.name!=="AbortError")throw P;return!1}}if(d){const h=await d.createWritable();await h.write(F),await h.close()}else throw new Error("无法获取文件句柄");return!0}catch(m){return m.name!=="AbortError"&&(console.error("Failed to update file:",m),alert("更新文件失败："+(m.message||"未知错误"))),!1}finally{K.value=!1}},isArticleFromContent:I}},ve={class:"layout edit-layout"},he={class:"hero"},ye={class:"edit-content"},be={key:0,class:"validation-errors"},_e={class:"error-header"},we={class:"error-title"},Se={class:"error-list"},ke={class:"form-section"},Ie=["placeholder"],Fe={class:"form-section"},Pe=["placeholder"],Ae={class:"form-row"},Ee={class:"form-section"},Ke=["value"],We={class:"form-section"},xe=["placeholder"],Ce={class:"form-row"},De={class:"form-section"},Ve={class:"form-section"},Ue=["placeholder"],$e={class:"form-row"},Oe={class:"form-section"},Te={class:"form-label"},Me=["placeholder"],Re={class:"form-section"},He={class:"cover-input-group"},Ne=["placeholder"],Be={class:"cover-actions"},Le={key:0,class:"cover-preview"},je=["src"],qe={class:"form-section"},ze={class:"form-label"},Je={class:"cover-presets"},Ye=["onClick"],Ge={class:"form-section"},Qe=["placeholder"],Xe={class:"form-hint"},Ze={class:"form-actions"},et=["disabled"],tt=ae({__name:"ArticleEditPage",setup(o){const l=D(null),v=D(),k=n=>{const t=n.target.files?.[0];if(t){if(!t.type.startsWith("image/")){alert(i("article.coverImageError"));return}if(t.size>5*1024*1024){alert(i("article.coverImageSizeError"));return}const b=new FileReader;b.onload=O=>{const R=O.target?.result;R&&(l.value=R,s.cover=R)},b.onerror=()=>{alert(i("article.coverImageError"))},b.readAsDataURL(t)}},K=()=>{l.value=null,v.value&&(v.value.value=""),s.cover=""},U=H(()=>{if(l.value)return l.value;if(s.cover){const n=s.cover.trim();if(n.startsWith("http://")||n.startsWith("https://")||n.startsWith("data:image/"))return n}return null}),W=re(),e=Z(),{t:i}=X(),I=H(()=>!!W.params.id),x=H(()=>{const n=W.params.id;return n||null}),{form:s,isSubmitting:V,isSavingFile:T,loadArticle:z,validateForm:M,resetForm:c,handlePublish:m,handleUpdate:F}=ge(),f=D([]),d=D(!1),{categories:h}=ue(!1),P=["linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)","linear-gradient(135deg, #0d121f 0%, #132642 50%, #243c5a 100%)","linear-gradient(135deg, #101820 0%, #1f1f2f 50%, #2c2c3b 100%)","linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)","linear-gradient(135deg, #2d1b69 0%, #11998e 100%)","linear-gradient(135deg, #667eea 0%, #764ba2 100%)"];oe(()=>{if(I.value&&x.value){const n=de(x.value);n?(z(n),n.cover&&(n.cover.startsWith("http://")||n.cover.startsWith("https://")||n.cover.startsWith("data:image/"))&&(l.value=n.cover)):e.push({name:"articles"})}else c()}),J(()=>[s.title,s.description,s.content,s.categoryKey,s.tag,s.date,s.platform,s.cover],()=>{if(d.value&&f.value.length>0){const n=M();f.value=n,n.length===0&&(d.value=!1)}}),J(()=>s.cover,n=>{n&&(n.startsWith("http://")||n.startsWith("https://")||n.startsWith("data:image/"))?(!l.value||l.value!==n)&&(l.value=n):n||(l.value=null)});const $=()=>{I.value&&x.value?e.push({name:"articleDetail",params:{id:x.value}}):e.push({name:"articles"})},C=async()=>{const n=M();if(n.length>0){f.value=n,d.value=!0,setTimeout(()=>{const u=document.querySelector(".form-error");u&&u.scrollIntoView({behavior:"smooth",block:"center"})},100);return}if(f.value=[],d.value=!1,I.value&&x.value){if(await F()){const{reloadArticles:t}=await ee(async()=>{const{reloadArticles:b}=await import("./index-C5E9Z3hJ.js").then(O=>O.i);return{reloadArticles:b}},__vite__mapDeps([0,1,2,3,4]));await t(),e.push({name:"articles"})}}else await m()&&e.push({name:"articles"})};return(n,u)=>(S(),_("main",ve,[r("section",he,[r("h1",null,p(I.value?a(i)("article.editTitle"):a(i)("article.createTitle")),1),r("p",null,p(I.value?a(i)("article.editDesc"):a(i)("article.createDesc")),1)]),r("section",ye,[d.value&&f.value.length>0?(S(),_("div",be,[r("div",_e,[u[11]||(u[11]=r("span",{class:"error-icon"},"⚠️",-1)),r("span",we,p(a(i)("article.validationError")),1)]),r("ul",Se,[(S(!0),_(B,null,L(f.value,(t,b)=>(S(),_("li",{key:b,class:"error-item"},p(a(i)(`article.${t.message}Required`)),1))),128))])])):N("",!0),r("form",{class:"article-form",onSubmit:se(C,["prevent"])},[r("div",ke,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="title")}])},[y(p(a(i)("article.title"))+" ",1),w(r("input",{"onUpdate:modelValue":u[0]||(u[0]=t=>a(s).title=t),type:"text",placeholder:a(i)("article.titlePlaceholder"),class:g({"form-error":d.value&&f.value.some(t=>t.field==="title")})},null,10,Ie),[[A,a(s).title]])],2)]),r("div",Fe,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="description")}])},[y(p(a(i)("article.description"))+" ",1),w(r("textarea",{"onUpdate:modelValue":u[1]||(u[1]=t=>a(s).description=t),rows:"3",placeholder:a(i)("article.descriptionPlaceholder"),class:g({"form-error":d.value&&f.value.some(t=>t.field==="description")})},null,10,Pe),[[A,a(s).description]])],2)]),r("div",Ae,[r("div",Ee,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="category")}])},[y(p(a(i)("article.category"))+" ",1),w(r("select",{"onUpdate:modelValue":u[2]||(u[2]=t=>a(s).categoryKey=t),class:g({"form-error":d.value&&f.value.some(t=>t.field==="category")})},[(S(!0),_(B,null,L(a(h),t=>(S(),_("option",{key:t.key,value:t.key},p(t.label),9,Ke))),128))],2),[[le,a(s).categoryKey]])],2)]),r("div",We,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="tag")}])},[y(p(a(i)("article.tag"))+" ",1),w(r("input",{"onUpdate:modelValue":u[3]||(u[3]=t=>a(s).tag=t),type:"text",placeholder:a(i)("article.tagPlaceholder"),class:g({"form-error":d.value&&f.value.some(t=>t.field==="tag")})},null,10,xe),[[A,a(s).tag]])],2)])]),r("div",Ce,[r("div",De,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="date")}])},[y(p(a(i)("article.date"))+" ",1),w(r("input",{"onUpdate:modelValue":u[4]||(u[4]=t=>a(s).date=t),type:"date",class:g({"form-error":d.value&&f.value.some(t=>t.field==="date")})},null,2),[[A,a(s).date]])],2)]),r("div",Ve,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="platform")}])},[y(p(a(i)("article.platform"))+" ",1),w(r("input",{"onUpdate:modelValue":u[5]||(u[5]=t=>a(s).platform=t),type:"text",placeholder:a(i)("article.platformPlaceholder"),class:g({"form-error":d.value&&f.value.some(t=>t.field==="platform")})},null,10,Ue),[[A,a(s).platform]])],2)])]),r("div",$e,[r("div",Oe,[r("label",Te,[y(p(a(i)("article.badge"))+" ",1),w(r("input",{"onUpdate:modelValue":u[6]||(u[6]=t=>a(s).badge=t),type:"text",placeholder:a(i)("article.badgePlaceholder")},null,8,Me),[[A,a(s).badge]])])]),r("div",Re,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="cover")}])},[y(p(a(i)("article.cover"))+" ",1),r("div",He,[w(r("input",{"onUpdate:modelValue":u[7]||(u[7]=t=>a(s).cover=t),type:"text",placeholder:a(i)("article.coverPlaceholder"),class:g({"form-error":d.value&&f.value.some(t=>t.field==="cover")})},null,10,Ne),[[A,a(s).cover]]),r("div",Be,[r("button",{type:"button",class:"cover-upload-btn",onClick:u[8]||(u[8]=t=>v.value?.click())},p(a(i)("article.uploadImage")),1),r("input",{ref_key:"coverFileInput",ref:v,type:"file",accept:"image/*",style:{display:"none"},onChange:k},null,544),U.value?(S(),_("button",{key:0,type:"button",class:"cover-clear-btn",onClick:K},p(a(i)("article.clearImage")),1)):N("",!0)])]),U.value?(S(),_("div",Le,[r("img",{src:U.value,alt:"Cover preview",onError:u[9]||(u[9]=t=>l.value=null)},null,40,je)])):N("",!0)],2)])]),r("div",qe,[r("label",ze,[y(p(a(i)("article.coverPresets"))+" ",1),r("div",Je,[(S(),_(B,null,L(P,(t,b)=>r("button",{key:b,type:"button",class:"cover-preset",style:ie({background:t}),onClick:O=>a(s).cover=t},null,12,Ye)),64))])])]),r("div",Ge,[r("label",{class:g(["form-label",{"has-error":d.value&&f.value.some(t=>t.field==="content")}])},[y(p(a(i)("article.content"))+" ",1),w(r("textarea",{"onUpdate:modelValue":u[10]||(u[10]=t=>a(s).content=t),rows:"20",placeholder:a(i)("article.contentPlaceholder"),class:g(["content-textarea",{"form-error":d.value&&f.value.some(t=>t.field==="content")}])},null,10,Qe),[[A,a(s).content]])],2),r("p",Xe,p(a(i)("article.contentHint")),1)]),r("div",Ze,[r("button",{type:"button",class:"cancel-btn",onClick:$},p(a(i)("article.cancel")),1),r("button",{type:"submit",class:"submit-btn",disabled:a(V)||a(T)},p(a(T)?a(i)("article.saving"):a(V)?a(i)("article.saving"):I.value?a(i)("article.update"):a(i)("article.publish")),9,et)])],32)])]))}}),nt=fe(tt,[["__scopeId","data-v-84960d4d"]]);export{nt as default};
