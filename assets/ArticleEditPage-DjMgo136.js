const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BGZPylNj.js","assets/vue-vendor-D_FnZyjM.js","assets/math-vendor-DA-ZBn8g.js","assets/markdown-vendor-BDlm1NQN.js","assets/index-DCljqfLO.css"])))=>i.map(i=>d[i]);
import{aA as J}from"./math-vendor-DA-ZBn8g.js";import{r as D,m as L,j as R,d as j,u as z,e as V,p as Y,q as G,s as Q,c as P,a as r,t as m,b as a,g as X,F as $,f as T,x as Z,n as p,h as v,w as b,v as k,y as ee,l as te,o as E}from"./vue-vendor-D_FnZyjM.js";import{c as ae,u as W,n as re,b as oe,g as le}from"./index-BGZPylNj.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./markdown-vendor-BDlm1NQN.js";function N(o){const i=[];return o.title&&i.push(`title: ${A(o.title)}`),o.description&&i.push(`description: ${A(o.description)}`),o.categoryKey&&i.push(`categoryKey: ${A(o.categoryKey)}`),o.tag&&i.push(`tag: ${A(o.tag)}`),o.badge&&i.push(`badge: ${A(o.badge)}`),o.date&&i.push(`date: ${A(o.date)}`),o.platform&&i.push(`platform: ${A(o.platform)}`),o.cover&&i.push(`cover: ${A(o.cover)}`),(i.length>0?`---
${i.join(`
`)}
---

`:"")+(o.content||"").trim()}function A(o){return o.includes(":")||o.includes("#")||o.includes("|")||o.includes("&")||o.includes("*")||o.includes("!")||o.includes("%")||o.includes("@")||o.includes("`")||o.startsWith(" ")||o.endsWith(" ")||o.includes(`
`)?`"${o.replace(/"/g,'\\"')}"`:o}function B(o){const i=o.date||new Date().toISOString().split("T")[0],e=(o.title||"untitled").toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim();return`${i}-${e}`}const O=new Map;function U(o,i){try{const f=localStorage.getItem("article-file-handles")||"{}",e=JSON.parse(f);e[o]=i,localStorage.setItem("article-file-handles",JSON.stringify(e))}catch(f){console.error("Failed to save file handle:",f)}}function ie(o){try{const i=localStorage.getItem("article-file-handles");if(i)return JSON.parse(i)[o]||null}catch(i){console.error("Failed to get file handle name:",i)}return null}const ne=()=>{const o=R(),i=D(!1),f=D(!1),e=L({title:"",description:"",content:"",categoryKey:"dit",tag:"",badge:"",date:new Date().toISOString().split("T")[0],platform:"Wechat",cover:"linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)"}),_=()=>{e.title="",e.description="",e.content="",e.categoryKey="dit",e.tag="",e.badge="",e.date=new Date().toISOString().split("T")[0],e.platform="Wechat",e.cover="linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)"},y=l=>ae.some(d=>d.id===l),s=l=>{e.id=l.id,e.title=l.title,e.description=l.description,e.content=l.content,e.categoryKey=l.categoryKey,e.tag=l.tag,e.badge=l.badge,e.date=l.date,e.platform=l.platform,e.cover=l.cover},F=()=>{const l=[];return e.title?.trim()||l.push({field:"title",message:"title"}),e.description?.trim()||l.push({field:"description",message:"description"}),e.content?.trim()||l.push({field:"content",message:"content"}),e.categoryKey||l.push({field:"category",message:"category"}),e.tag?.trim()||l.push({field:"tag",message:"tag"}),e.date||l.push({field:"date",message:"date"}),e.platform?.trim()||l.push({field:"platform",message:"platform"}),e.cover?.trim()||l.push({field:"cover",message:"cover"}),l},I=async()=>{if(F().length>0)return null;i.value=!0;try{let d;return e.id?d=W(e.id,e):d=oe(e),d}finally{i.value=!1}};return{form:e,isSubmitting:i,isSavingFile:f,resetForm:_,loadArticle:s,validateForm:F,handleSubmit:I,handleSubmitAndRedirect:async()=>{const l=await I();l&&o.push({name:"articleDetail",params:{id:l.id}})},handlePublish:async()=>{if(F().length>0)return!1;if(!("showDirectoryPicker"in window))return alert("您的浏览器不支持文件系统访问 API，请使用 Chrome、Edge 或 Opera 浏览器"),!1;f.value=!0;try{const d={id:e.id||re(),title:e.title||"",description:e.description||"",content:e.content||"",categoryKey:e.categoryKey||"dit",tag:e.tag||"",badge:e.badge,date:e.date||new Date().toISOString().split("T")[0],platform:e.platform||"Wechat",cover:e.cover||""},n=N(d),c=B(d)+".md",g=await(await window.showDirectoryPicker()).getFileHandle(c,{create:!0}),S=await g.createWritable();return await S.write(n),await S.close(),d.id&&(O.set(d.id,g),U(d.id,c)),!0}catch(d){return d.name!=="AbortError"&&(console.error("Failed to save file:",d),alert("保存文件失败："+(d.message||"未知错误"))),!1}finally{f.value=!1}},handleUpdate:async()=>{if(F().length>0||!e.id)return!1;if(!("showSaveFilePicker"in window))return alert("您的浏览器不支持文件系统访问 API，请使用 Chrome、Edge 或 Opera 浏览器"),!1;f.value=!0;try{const d={id:e.id,title:e.title||"",description:e.description||"",content:e.content||"",categoryKey:e.categoryKey||"dit",tag:e.tag||"",badge:e.badge,date:e.date||new Date().toISOString().split("T")[0],platform:e.platform||"Wechat",cover:e.cover||""},n=N(d),c=B(d)+".md";let w=O.get(e.id);if(!w){const g=ie(e.id);try{w=(await window.showOpenFilePicker({types:[{description:"Markdown files",accept:{"text/markdown":[".md"]}}],multiple:!1}))[0],O.set(e.id,w),g?U(e.id,g):U(e.id,c)}catch(S){if(S.name!=="AbortError")throw S;return!1}}if(w){const g=await w.createWritable();await g.write(n),await g.close()}else throw new Error("无法获取文件句柄");if(!y(e.id))try{W(e.id,d)}catch(g){console.warn("Failed to update article in memory:",g)}return!0}catch(d){return d.name!=="AbortError"&&(console.error("Failed to update file:",d),alert("更新文件失败："+(d.message||"未知错误"))),!1}finally{f.value=!1}},isArticleFromContent:y}},ce={class:"layout edit-layout"},de={class:"hero"},ue={class:"edit-content"},fe={key:0,class:"validation-errors"},me={class:"error-header"},pe={class:"error-title"},ge={class:"error-list"},he={class:"form-section"},ve=["placeholder"],ye={class:"form-section"},be=["placeholder"],_e={class:"form-row"},we={class:"form-section"},Se=["value"],ke={class:"form-section"},Ae=["placeholder"],Fe={class:"form-row"},Pe={class:"form-section"},Ee={class:"form-section"},Ie=["placeholder"],xe={class:"form-row"},De={class:"form-section"},Ke={class:"form-label"},Ve=["placeholder"],$e={class:"form-section"},Te=["placeholder"],Oe={class:"form-section"},Ue={class:"form-label"},Ce={class:"cover-presets"},He=["onClick"],Me={class:"form-section"},We=["placeholder"],Ne={class:"form-hint"},Be={class:"form-actions"},Re=["disabled"],qe=j({__name:"ArticleEditPage",setup(o){const i=Y(),f=R(),{t:e}=z(),_=V(()=>!!i.params.id),y=V(()=>{const h=i.params.id;return h||null}),{form:s,isSubmitting:F,isSavingFile:I,loadArticle:C,validateForm:K,resetForm:H,handlePublish:l,handleUpdate:d}=ne(),n=D([]),c=D(!1),w=V(()=>[{key:"dit",label:e("categories.dit")},{key:"luna",label:e("categories.luna")},{key:"note",label:e("categories.note")},{key:"art",label:e("categories.art")},{key:"travel",label:e("categories.travel")}]),g=["linear-gradient(135deg, #0a0f26 0%, #0c1a4d 35%, #032c5f 65%, #0c1a4d 100%)","linear-gradient(135deg, #0d121f 0%, #132642 50%, #243c5a 100%)","linear-gradient(135deg, #101820 0%, #1f1f2f 50%, #2c2c3b 100%)","linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)","linear-gradient(135deg, #2d1b69 0%, #11998e 100%)","linear-gradient(135deg, #667eea 0%, #764ba2 100%)"];G(()=>{if(_.value&&y.value){const h=le(y.value);h?C(h):f.push({name:"articles"})}else H()}),Q(()=>[s.title,s.description,s.content,s.categoryKey,s.tag,s.date,s.platform,s.cover],()=>{if(c.value&&n.value.length>0){const h=K();n.value=h,h.length===0&&(c.value=!1)}});const S=()=>{_.value&&y.value?f.push({name:"articleDetail",params:{id:y.value}}):f.push({name:"articles"})},q=async()=>{const h=K();if(h.length>0){n.value=h,c.value=!0,setTimeout(()=>{const u=document.querySelector(".form-error");u&&u.scrollIntoView({behavior:"smooth",block:"center"})},100);return}if(n.value=[],c.value=!1,_.value&&y.value){if(await d()){const{reloadArticles:t}=await J(async()=>{const{reloadArticles:x}=await import("./index-BGZPylNj.js").then(M=>M.i);return{reloadArticles:x}},__vite__mapDeps([0,1,2,3,4]));await t(),f.push({name:"articleDetail",params:{id:y.value}})}}else await l()&&f.push({name:"articles"})};return(h,u)=>(E(),P("main",ce,[r("section",de,[r("h1",null,m(_.value?a(e)("article.editTitle"):a(e)("article.createTitle")),1),r("p",null,m(_.value?a(e)("article.editDesc"):a(e)("article.createDesc")),1)]),r("section",ue,[c.value&&n.value.length>0?(E(),P("div",fe,[r("div",me,[u[9]||(u[9]=r("span",{class:"error-icon"},"⚠️",-1)),r("span",pe,m(a(e)("article.validationError")),1)]),r("ul",ge,[(E(!0),P($,null,T(n.value,(t,x)=>(E(),P("li",{key:x,class:"error-item"},m(a(e)(`article.${t.message}Required`)),1))),128))])])):X("",!0),r("form",{class:"article-form",onSubmit:Z(q,["prevent"])},[r("div",he,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="title")}])},[v(m(a(e)("article.title"))+" ",1),b(r("input",{"onUpdate:modelValue":u[0]||(u[0]=t=>a(s).title=t),type:"text",placeholder:a(e)("article.titlePlaceholder"),class:p({"form-error":c.value&&n.value.some(t=>t.field==="title")})},null,10,ve),[[k,a(s).title]])],2)]),r("div",ye,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="description")}])},[v(m(a(e)("article.description"))+" ",1),b(r("textarea",{"onUpdate:modelValue":u[1]||(u[1]=t=>a(s).description=t),rows:"3",placeholder:a(e)("article.descriptionPlaceholder"),class:p({"form-error":c.value&&n.value.some(t=>t.field==="description")})},null,10,be),[[k,a(s).description]])],2)]),r("div",_e,[r("div",we,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="category")}])},[v(m(a(e)("article.category"))+" ",1),b(r("select",{"onUpdate:modelValue":u[2]||(u[2]=t=>a(s).categoryKey=t),class:p({"form-error":c.value&&n.value.some(t=>t.field==="category")})},[(E(!0),P($,null,T(w.value,t=>(E(),P("option",{key:t.key,value:t.key},m(t.label),9,Se))),128))],2),[[ee,a(s).categoryKey]])],2)]),r("div",ke,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="tag")}])},[v(m(a(e)("article.tag"))+" ",1),b(r("input",{"onUpdate:modelValue":u[3]||(u[3]=t=>a(s).tag=t),type:"text",placeholder:a(e)("article.tagPlaceholder"),class:p({"form-error":c.value&&n.value.some(t=>t.field==="tag")})},null,10,Ae),[[k,a(s).tag]])],2)])]),r("div",Fe,[r("div",Pe,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="date")}])},[v(m(a(e)("article.date"))+" ",1),b(r("input",{"onUpdate:modelValue":u[4]||(u[4]=t=>a(s).date=t),type:"date",class:p({"form-error":c.value&&n.value.some(t=>t.field==="date")})},null,2),[[k,a(s).date]])],2)]),r("div",Ee,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="platform")}])},[v(m(a(e)("article.platform"))+" ",1),b(r("input",{"onUpdate:modelValue":u[5]||(u[5]=t=>a(s).platform=t),type:"text",placeholder:a(e)("article.platformPlaceholder"),class:p({"form-error":c.value&&n.value.some(t=>t.field==="platform")})},null,10,Ie),[[k,a(s).platform]])],2)])]),r("div",xe,[r("div",De,[r("label",Ke,[v(m(a(e)("article.badge"))+" ",1),b(r("input",{"onUpdate:modelValue":u[6]||(u[6]=t=>a(s).badge=t),type:"text",placeholder:a(e)("article.badgePlaceholder")},null,8,Ve),[[k,a(s).badge]])])]),r("div",$e,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="cover")}])},[v(m(a(e)("article.cover"))+" ",1),b(r("input",{"onUpdate:modelValue":u[7]||(u[7]=t=>a(s).cover=t),type:"text",placeholder:a(e)("article.coverPlaceholder"),class:p({"form-error":c.value&&n.value.some(t=>t.field==="cover")})},null,10,Te),[[k,a(s).cover]])],2)])]),r("div",Oe,[r("label",Ue,[v(m(a(e)("article.coverPresets"))+" ",1),r("div",Ce,[(E(),P($,null,T(g,(t,x)=>r("button",{key:x,type:"button",class:"cover-preset",style:te({background:t}),onClick:M=>a(s).cover=t},null,12,He)),64))])])]),r("div",Me,[r("label",{class:p(["form-label",{"has-error":c.value&&n.value.some(t=>t.field==="content")}])},[v(m(a(e)("article.content"))+" ",1),b(r("textarea",{"onUpdate:modelValue":u[8]||(u[8]=t=>a(s).content=t),rows:"20",placeholder:a(e)("article.contentPlaceholder"),class:p(["content-textarea",{"form-error":c.value&&n.value.some(t=>t.field==="content")}])},null,10,We),[[k,a(s).content]])],2),r("p",Ne,m(a(e)("article.contentHint")),1)]),r("div",Be,[r("button",{type:"button",class:"cancel-btn",onClick:S},m(a(e)("article.cancel")),1),r("button",{type:"submit",class:"submit-btn",disabled:a(F)||a(I)},m(a(I)?a(e)("article.saving"):a(F)?a(e)("article.saving"):_.value?a(e)("article.update"):a(e)("article.publish")),9,Re)])],32)])]))}}),Ge=se(qe,[["__scopeId","data-v-f85a0eb9"]]);export{Ge as default};
